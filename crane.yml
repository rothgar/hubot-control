---
containers:
  hubot-control-data:
    image: busybox
    volume: ["/usr/src/app"]
    detach: true
    cmd: ["true"]

  hubot-control-db:
    image: postgres:9.3
    run:
      env: ["POSTGRES_USER=hubot_control","POSTGRES_PASSWORD=hubot"]
      detach: true
      volumes-from: ["hubot-control-data"]
      volume: ["./init.sh:/docker-entrypoint-initdb.d/init.sh"]

  hubot-db-migration:
    image: hubot-control
    run:
      interactive: true
      rm: true
      env: ["RAILS_DB_USERNAME=hubot","RAILS_DB_PASSWORD=hubot"]
      link: ["hubot-control-db:db"]
      cmd: bundle exec rake db:migrate RAILS_ENV=production

  hubot-control-web:
    dockerfile: Dockerfile
    image: hubot-control
    run:
      detach: false
      env: ["RAILS_DB_USERNAME=hubot_control","RAILS_DB_PASSWORD=hubot"]
      link: ["hubot-control-db:db"]
      volumes-from: ["hubot-control-data"]
      publish: ["3000:3000"]

groups:
  hubot-control-db: ["hubot-control-db","hubot-db-migration"]
  hubot-control: ["hubot-control-data","hubot-control-web"]
